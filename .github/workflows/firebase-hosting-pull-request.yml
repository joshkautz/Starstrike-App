# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting Preview Channel

on: pull_request

permissions: write-all

jobs:
  job:
    name: Checkout and Deploy to Firebase Hosting Preview Channel
    if: github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Deploy to Firebase Hosting Preview Channel
        env:
          GCP_SA_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_STARSTRUCK_GITHUB_APP_BEE1B }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_PR: ${{ github.event.pull_request.number }}
        run: |
          # Install Firebase Tools
          curl -sL https://firebase.tools | bash
          echo "$GCP_SA_KEY" > /opt/gcp_key.json
          export GOOGLE_APPLICATION_CREDENTIALS=/opt/gcp_key.json

          # Deploy to Firebase Hosting Preview Channel
          DATE=$(date +'%A-%m-%d-%Y-%H-%M-%S')
          CHANNEL="Preview-"$DATE
          DEPLOYMENT_OUPUT=$(firebase hosting:channel:deploy $CHANNEL --expires 3d --json)
          PREVIEW_CHANNEL_URL=$(echo "$DEPLOYMENT_OUPUT" | grep -E -o '(http|https)://[a-zA-Z0-9./?=_%:-]*.web.app')

          # Use GitHub CLI to comment the new Firebase Hosting Preview Channel URL.
          gh pr comment $GH_PR --body "Here is your Preview Channel URL: $PREVIEW_CHANNEL_URL"
